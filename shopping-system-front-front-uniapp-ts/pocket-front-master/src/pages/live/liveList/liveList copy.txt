<template>

  
  <scroll-view scroll-y class="viewport" id="scroller" @scrolltolower="onScrollToLower" 
    refresher-enabled :refresher-triggered="refreshing" @refresherrefresh="onRefresh">
    
    <!-- æœç´¢åŒºåŸŸ -->
    <view class="search-section" :style="{ paddingTop: safeAreaInsets?.top + 20 + 'px' }">
      <view class="search-box">
        <text class="icon-search"></text>
        <input 
          class="search-input" 
          v-model="searchKeyword" 
          placeholder="æœç´¢ç›´æ’­é—´æˆ–ä¸»æ’­"
          confirm-type="search"
        />
        <text v-if="searchKeyword" class="icon-close" @tap="clearSearch"></text>
      </view>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view v-if="loading && !refreshing" class="loading">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½ç›´æ’­é—´...</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view v-else-if="!loading && filteredRooms.length === 0" class="empty">
      <view class="empty-icon">ğŸ“º</view>
      <text class="empty-text">{{ searchKeyword ? 'æœªæ‰¾åˆ°ç›¸å…³ç›´æ’­é—´' : 'æš‚æ— ç›´æ’­é—´' }}</text>
      <text class="empty-desc">{{ searchKeyword ? 'å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢' : 'å½“å‰æ²¡æœ‰æ­£åœ¨ç›´æ’­çš„æˆ¿é—´' }}</text>
      <view v-if="!searchKeyword" class="empty-button" @tap="refreshRoomList">åˆ·æ–°è¯•è¯•</view>
      <view v-else class="empty-button" @tap="clearSearch">æ¸…é™¤æœç´¢</view>
    </view>
    
    <!-- ç›´æ’­é—´åˆ—è¡¨ -->
    <view v-else-if="!loading" class="room-list">
      <view 
        v-for="room in filteredRooms" 
        :key="room.roomId"
        class="room-item"
        @tap="enterRoom(room)"
      >
        <!-- ç›´æ’­é—´å°é¢ -->
        <view class="room-cover">
          <image 
            class="cover-image" 
            :src="room.thumbnail || getDefaultCover()" 
            mode="aspectFill"
            @error="handleImageError"
          ></image>
          <view class="live-badge">
            <text class="live-text">LIVE</text>
          </view>
          <view class="viewer-count">
            <text class="viewer-icon icon-eye"></text>
            <text class="viewer-number">{{ formatViewerCount(room.viewerCount) }}</text>
          </view>
        </view>
        
        <!-- ç›´æ’­é—´ä¿¡æ¯ -->
        <view class="room-info">
          <view class="room-title">{{ room.title }}</view>
          <view class="room-meta">
            <view class="streamer-info">
              <image 
                class="streamer-avatar" 
                :src="room.streamerAvatar || getDefaultAvatar()" 
                mode="aspectFill"
                @error="handleAvatarError"
              ></image>
              <text class="streamer-name">{{ room.streamerName }}</text>
            </view>
            <view class="room-stats">
              <text class="duration-icon icon-clock"></text>
              <text class="duration-text">{{ formatDuration(room.duration) }}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- åº•éƒ¨æç¤º -->
    <view v-if="!loading && !refreshing && filteredRooms.length > 0" class="bottom-tips">
      <text class="tips-text">å·²æ˜¾ç¤ºå…¨éƒ¨ç›´æ’­é—´</text>
    </view>
    
    <!-- åº•éƒ¨å®‰å…¨åŒºåŸŸ -->
    <view class="safe-area" :style="{ height: safeAreaInsets?.bottom + 'px' }"></view>
  </scroll-view>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue'
import { getLiveRoomListAPI } from '@/services/live'

// è·å–å±å¹•è¾¹ç•Œåˆ°å®‰å…¨åŒºåŸŸè·ç¦»
const { safeAreaInsets } = uni.getSystemInfoSync()

// å“åº”å¼æ•°æ®
const loading = ref(false)
const refreshing = ref(false)
const searchKeyword = ref('')
const roomList = ref([])
const hasError = ref(false)

// è·å–é¡µé¢æ ˆ
const pages = getCurrentPages()

// è·å–é»˜è®¤å°é¢
const getDefaultCover = () => {
  // ä½¿ç”¨base64ç¼–ç çš„1x1åƒç´ å›¾ç‰‡ä½œä¸ºå ä½ç¬¦
  return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzYwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDM2MCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzNjAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik0xNjUgNzVIMTk1VjEyNUgxNjVWNzVaIiBmaWxsPSIjQ0NDIi8+CjxwYXRoIGQ9Ik0xNjUgNzVMMTg1IDk1TDE5NSA3NUgxNjVaIiBmaWxsPSIjOTk5Ii8+Cjx0ZXh0IHg9IjE4MCIgeT0iMTQwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEyIj7nm7TmkK3lsIHpnaI8L3RleHQ+Cjwvc3ZnPg=='
}

// è·å–é»˜è®¤å¤´åƒ
const getDefaultAvatar = () => {
  return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyNCIgcj0iMjQiIGZpbGw9IiNGNUY1RjUiLz4KPGNpcmNsZSBjeD0iMjQiIGN5PSIyMCIgcj0iOCIgZmlsbD0iI0NDQyIvPgo8cGF0aCBkPSJNMTAgMzZDMTAgMzAgMTYuNSAyNiAyNCAyNkMzMS41IDI2IDM4IDMwIDM4IDM2IiBzdHJva2U9IiNDQ0MiIHN0cm9rZS13aWR0aD0iMiIgZmlsbD0ibm9uZSIvPgo8L3N2Zz4K'
}

// å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
const handleImageError = (e) => {
  e.target.src = getDefaultCover()
}

const handleAvatarError = (e) => {
  e.target.src = getDefaultAvatar()
}


const transformRoomData = (room) => {
  return {
    roomId: room.roomId,
    title: room.title,
    description: room.description,
    streamerName: room.streamerName || 'admin', // åç«¯ streamerName ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
    streamerId: room.streamerId,
    viewerCount: room.viewerCount || 0,
    totalViewers: room.totalViewers || 0,
    likeCount: room.likeCount || 0,
    status: room.status,
    statusText: room.statusText,
    startTime: room.startTime,
    endTime: room.endTime,
    // å¤„ç†ç¼ºå¤±çš„å­—æ®µ
    thumbnail: room.coverImage || null, // ä½¿ç”¨ coverImage ä½œä¸º thumbnail
    streamerAvatar: null, // åç«¯æ²¡æœ‰æä¾›ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ
    duration: room.startTime ? Math.floor((Date.now() - new Date(room.startTime).getTime()) / 1000) : 0
  }
}

// ä»åç«¯è·å–ç›´æ’­é—´åˆ—è¡¨
const getLiveRoomList = async () => {
  try {
    hasError.value = false
    const response = await getLiveRoomListAPI({
      page: 1,
      pageSize: 20,
      status: 1
    })
    
    if (response.code === 200 && response.data && response.data.rows) {
      // è½¬æ¢æ•°æ®æ ¼å¼
      const transformedRooms = response.data.rows.map(transformRoomData)
      console.log('è½¬æ¢åçš„ç›´æ’­é—´æ•°æ®:', transformedRooms)
      return transformedRooms
    }
    
    console.warn('åç«¯è¿”å›æ ¼å¼å¼‚å¸¸:', response)
    return []
  } catch (error) {
    console.error('è·å–ç›´æ’­é—´åˆ—è¡¨å¤±è´¥:', error)
    hasError.value = true
    uni.showToast({
      title: 'è·å–ç›´æ’­é—´åˆ—è¡¨å¤±è´¥',
      icon: 'none',
      duration: 2000
    })
    return []
  }
}

// è®¡ç®—å±æ€§ - è¿‡æ»¤åçš„ç›´æ’­é—´
const filteredRooms = computed(() => {
  if (!searchKeyword.value.trim()) {
    return roomList.value
  }
  
  const keyword = searchKeyword.value.toLowerCase().trim()
  return roomList.value.filter(room => 
    room.title.toLowerCase().includes(keyword) ||
    room.streamerName.toLowerCase().includes(keyword)
  )
})

// æ¸…é™¤æœç´¢
const clearSearch = () => {
  searchKeyword.value = ''
}

// åˆ·æ–°ç›´æ’­é—´åˆ—è¡¨
const refreshRoomList = async () => {
  if (loading.value) return
  
  loading.value = true
  try {
    const rooms = await getLiveRoomList()
    roomList.value = rooms
    console.log('è·å–åˆ°ç›´æ’­é—´:', rooms.length, 'ä¸ª')
    
    if (rooms.length === 0 && !hasError.value) {
      uni.showToast({
        title: 'å½“å‰æš‚æ— ç›´æ’­é—´',
        icon: 'none',
        duration: 2000
      })
    }
  } catch (error) {
    console.error('åˆ·æ–°å¤±è´¥:', error)
  } finally {
    loading.value = false
  }
}

// ä¸‹æ‹‰åˆ·æ–°
const onRefresh = async () => {
  if (refreshing.value) return
  
  refreshing.value = true
  try {
    const rooms = await getLiveRoomList()
    roomList.value = rooms
    console.log('åˆ·æ–°è·å–åˆ°ç›´æ’­é—´:', rooms.length, 'ä¸ª')
    
    uni.showToast({
      title: 'åˆ·æ–°æˆåŠŸ',
      icon: 'success',
      duration: 1500
    })
  } catch (error) {
    console.error('ä¸‹æ‹‰åˆ·æ–°å¤±è´¥:', error)
  } finally {
    refreshing.value = false
  }
}

// ä¸Šæ‹‰åŠ è½½
const onScrollToLower = () => {
  // å¯ä»¥åœ¨è¿™é‡Œå®ç°åˆ†é¡µåŠ è½½
  console.log('è§¦å‘ä¸Šæ‹‰åŠ è½½')
}

// è¿›å…¥ç›´æ’­é—´
const enterRoom = (room) => {
  console.log('è¿›å…¥ç›´æ’­é—´:', room)
  
  // è·³è½¬åˆ°è§‚ä¼—é¡µé¢ï¼Œä¼ é€’ç›´æ’­é—´ä¿¡æ¯
  uni.navigateTo({
    url: `/pages/live/live-streaming/live-streaming?roomId=${room.roomId}&streamerName=${encodeURIComponent(room.streamerName)}&title=${encodeURIComponent(room.title)}`
  })
}

// æ ¼å¼åŒ–è§‚çœ‹äººæ•°
const formatViewerCount = (count) => {
  if (count >= 10000) {
    return `${(count / 10000).toFixed(1)}ä¸‡`
  } else if (count >= 1000) {
    return `${(count / 1000).toFixed(1)}k`
  }
  return count.toString()
}

// æ ¼å¼åŒ–ç›´æ’­æ—¶é•¿
const formatDuration = (seconds) => {
  const hours = Math.floor(seconds / 3600)
  const minutes = Math.floor((seconds % 3600) / 60)
  if (hours > 0) {
    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`
  }
  return `${minutes}åˆ†é’Ÿ`
}

// ç”Ÿå‘½å‘¨æœŸ
onMounted(() => {
  // å»¶è¿Ÿä¸€ä¸‹å†åŠ è½½ï¼Œé¿å…é¡µé¢é—ªçƒ
  setTimeout(() => {
    refreshRoomList()
  }, 100)
})
</script>

<style lang="scss">
page {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
  background-color: #f7f7f8;
}



/* æ»šåŠ¨è§†å›¾æ ·å¼ */
.viewport {
  background-color: #f7f7f8;
  height: 100vh;
}

/* æœç´¢åŒºåŸŸæ ·å¼ */
.search-section {
  padding: 20rpx 30rpx;
  background-color: #cf4261;
  
  .search-box {
    position: relative;
    display: flex;
    align-items: center;
    height: 64rpx;
    background-color: #fff;
    border-radius: 32rpx;
    padding: 0 20rpx;
  }
  
  .icon-search {
    font-size: 32rpx;
    color: #666;
    margin-right: 10rpx;
  }
  
  .search-input {
    flex: 1;
    height: 64rpx;
    font-size: 28rpx;
    color: #333;
  }
  
  .icon-close {
    font-size: 32rpx;
    color: #999;
    padding: 10rpx;
  }
}

/* åŠ è½½çŠ¶æ€æ ·å¼ */
.loading {
  padding: 100rpx 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  
  .loading-spinner {
    width: 60rpx;
    height: 60rpx;
    border: 4rpx solid #f3f3f3;
    border-top: 4rpx solid #cf4261;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 20rpx;
  }
  
  .loading-text {
    font-size: 28rpx;
    color: #999;
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ç©ºçŠ¶æ€æ ·å¼ */
.empty {
  padding: 120rpx 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  
  .empty-icon {
    font-size: 120rpx;
    margin-bottom: 30rpx;
    opacity: 0.5;
  }
  
  .empty-text {
    font-size: 32rpx;
    color: #666;
    margin-bottom: 10rpx;
  }
  
  .empty-desc {
    font-size: 26rpx;
    color: #999;
    margin-bottom: 30rpx;
  }
  
  .empty-button {
    padding: 20rpx 40rpx;
    background-color: #cf4261;
    color: #fff;
    font-size: 28rpx;
    border-radius: 40rpx;
    
    &:active {
      background-color: #b8395a;
    }
  }
}

/* ç›´æ’­é—´åˆ—è¡¨æ ·å¼ */
.room-list {
  padding: 20rpx;
  
  .room-item {
    margin-bottom: 30rpx;
    border-radius: 12rpx;
    background-color: #fff;
    overflow: hidden;
    box-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.05);
    
    &:active {
      transform: scale(0.98);
      transition: transform 0.2s ease;
    }
  }
  
  .room-cover {
    position: relative;
    width: 100%;
    height: 360rpx;
    background-color: #f5f5f5;
    
    .cover-image {
      width: 100%;
      height: 100%;
    }
    
    .live-badge {
      position: absolute;
      top: 20rpx;
      left: 20rpx;
      background-color: #ff4444;
      padding: 6rpx 16rpx;
      border-radius: 6rpx;
      
      .live-text {
        font-size: 24rpx;
        color: #fff;
        font-weight: bold;
      }
    }
    
    .viewer-count {
      position: absolute;
      bottom: 20rpx;
      right: 20rpx;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 6rpx 16rpx;
      border-radius: 20rpx;
      display: flex;
      align-items: center;
      
      .viewer-icon {
        font-size: 24rpx;
        color: #fff;
        margin-right: 6rpx;
      }
      
      .viewer-number {
        font-size: 24rpx;
        color: #fff;
      }
    }
  }
  
  .room-info {
    padding: 20rpx;
    
    .room-title {
      font-size: 30rpx;
      font-weight: bold;
      color: #333;
      margin-bottom: 16rpx;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .room-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      
      .streamer-info {
        display: flex;
        align-items: center;
        flex: 1;
        margin-right: 20rpx;
        
        .streamer-avatar {
          width: 48rpx;
          height: 48rpx;
          border-radius: 50%;
          margin-right: 10rpx;
          background-color: #f5f5f5;
        }
        
        .streamer-name {
          font-size: 26rpx;
          color: #666;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
      }
      
      .room-stats {
        display: flex;
        align-items: center;
        
        .duration-icon {
          font-size: 24rpx;
          color: #999;
          margin-right: 6rpx;
        }
        
        .duration-text {
          font-size: 24rpx;
          color: #999;
        }
      }
    }
  }
}

/* åº•éƒ¨æç¤ºæ ·å¼ */
.bottom-tips {
  text-align: center;
  padding: 30rpx 0;
  
  .tips-text {
    font-size: 24rpx;
    color: #999;
  }
}

/* åº•éƒ¨å®‰å…¨åŒºåŸŸ */
.safe-area {
  width: 100%;
}

/* å›¾æ ‡æ ·å¼ */
.icon-search::before {
  content: '\e7de';
  font-family: 'iconfont';
}

.icon-close::before {
  content: '\e7fc';
  font-family: 'iconfont';
}

.icon-eye::before {
  content: '\e78f';
  font-family: 'iconfont';
}

.icon-clock::before {
  content: '\e74f';
  font-family: 'iconfont';
}
</style>