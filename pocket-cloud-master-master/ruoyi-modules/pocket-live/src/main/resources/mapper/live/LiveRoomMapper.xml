<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.live.mapper.LiveRoomMapper">
    
    <resultMap id="LiveRoomResult" type="com.ruoyi.live.domain.LiveRoom">
        <id property="id" column="id"/>
        <result property="roomId" column="room_id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="streamerId" column="streamer_id"/>
        <result property="streamerName" column="streamer_name"/>
        <result property="coverImage" column="cover_image"/>
        <result property="status" column="status"/>
        <result property="viewerCount" column="viewer_count"/>
        <result property="totalViewers" column="total_viewers"/>
        <result property="likeCount" column="like_count"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="delFlag" column="del_flag"/>
        <result property="productId" column="product_id"/>
        <result property="replayEnabled" column="replay_enabled"/>
        <result property="replayUrl" column="replay_url"/>
    </resultMap>
    
    <!-- 根据房间ID查询直播间 -->
    <select id="selectByRoomId" resultMap="LiveRoomResult">
        SELECT * FROM live_room
        WHERE room_id = #{roomId} AND del_flag = '0'
    </select>
    
    <!-- 查询正在直播的房间列表 -->
    <select id="selectLivingRooms" resultMap="LiveRoomResult">
        SELECT * FROM live_room
        WHERE status = 1 AND del_flag = '0'
        ORDER BY create_time DESC
    </select>
    
    <!-- 根据主播ID查询直播间列表 -->
    <select id="selectByStreamerId" resultMap="LiveRoomResult">
        SELECT * FROM live_room
        WHERE streamer_id = #{streamerId} AND del_flag = '0'
        ORDER BY create_time DESC
    </select>
    
    <!-- 分页查询指定状态的直播间列表 -->
    <select id="selectLiveRoomsByStatusWithPage" resultMap="LiveRoomResult">
        SELECT * FROM live_room
        WHERE status = #{status} AND del_flag = '0'
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计指定状态的直播间数量 -->
    <select id="countLiveRoomsByStatus" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM live_room
        WHERE status = #{status} AND del_flag = '0'
    </select>
    
    <!-- 更新直播间观看人数 -->
    <update id="updateViewerCount">
        UPDATE live_room
        SET viewer_count = #{viewerCount}, update_time = NOW()
        WHERE room_id = #{roomId}
    </update>
    
    <!-- 增加总观看人数 -->
    <update id="incrementTotalViewers">
        UPDATE live_room
        SET total_viewers = total_viewers + #{increment}, update_time = NOW()
        WHERE room_id = #{roomId}
    </update>
    
    <!-- 增加点赞数 -->
    <update id="incrementLikeCount">
        UPDATE live_room
        SET like_count = like_count + #{increment}, update_time = NOW()
        WHERE room_id = #{roomId}
    </update>
    
    <!-- 更新直播间状态 -->
    <update id="updateStatus">
        UPDATE live_room
        SET status = #{status}, update_time = NOW()
        <if test="status == 1">
            , start_time = NOW()
        </if>
        <if test="status == 2">
            , end_time = NOW()
        </if>
        WHERE room_id = #{roomId}
    </update>
</mapper> 